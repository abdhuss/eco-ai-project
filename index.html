<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco AI - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    <style>
        :root { --bg: #121212; --chat-bg: #1e1e1e; --primary: #00ff9d; --text: #e0e0e0; --bot-bg: #2b2b2b; --user-bg: #005f40; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 600px; height: 95vh; background: var(--chat-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; border: 1px solid #333; }
        .header { padding: 20px; text-align: center; border-bottom: 1px solid #333; background: linear-gradient(45deg, #1e1e1e, #252525); border-radius: 20px 20px 0 0; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bot-message { background: var(--bot-bg); align-self: flex-start; border-bottom-left-radius: 2px; }
        .user-message { background: var(--user-bg); align-self: flex-end; border-bottom-right-radius: 2px; color: white; }
        .input-area { padding: 20px; background: #2d2d2d; border-radius: 0 0 20px 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background: #121212; color: white; outline: none; }
        button { padding: 10px 25px; border: none; background: var(--primary); border-radius: 25px; cursor: pointer; font-weight: bold; }
        .typing { font-style: italic; color: #888; font-size: 0.8rem; margin: 0 20px 5px 0; display: none; }
        .weather-card { background: linear-gradient(135deg, #2c3e50, #000000); padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #00bcd4; }
        .weather-detail { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
    </style>
    <script type="importmap">{"imports": {"@google/generative-ai": "https://esm.run/@google/generative-ai"}}</script>
</head>
<body>

<div class="container">
    <div class="header"><h1>ECO AI ğŸŒ</h1><span>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¦ÙŠ (Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©)</span></div>
    <div class="chat-box" id="chatBox"></div>
    <div class="typing" id="typing">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...</div>
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." autocomplete="off">
        <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // ============================================
    // âš ï¸ Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
    const API_KEY = "AIzaSyAc2mXSgwQkqzuYSN7-E9qiSx_zDlzBKNI"; 
    // ============================================

    let genAI, model;
    try {
        genAI = new GoogleGenerativeAI(API_KEY);
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø§Ù„Ù…ØªÙˆÙØ± Ù„Ø¯ÙŠÙƒ
        model = genAI.getGenerativeModel({ model: "gemini-2.5-flash"});
    } catch (e) { console.error(e); }

    let userData = { name: "", age: 0, height: 0, weight: 0, asthma: false, heart: false, skin: false, location: "", lat: 0, lon: 0 };
    let step = 0;
    let weatherData = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ

    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const typing = document.getElementById('typing');
    const sendBtn = document.getElementById('sendBtn');

    window.onload = checkReturningUser;

    function checkReturningUser() {
        const stored = localStorage.getItem('ecoAI_user');
        if (stored) {
            userData = JSON.parse(stored);
            step = 7;
            addBot(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ${userData.name}! Ø£ÙŠÙ† Ø£Ù†Øª Ø§Ù„Ø¢Ù†ØŸ`);
        } else {
            addBot("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Eco AI. Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ");
        }
    }

    sendBtn.onclick = () => handleSend();
    userInput.onkeypress = (e) => { if(e.key==="Enter") handleSend() };

    function handleSend() {
        const txt = userInput.value.trim();
        if(!txt) return;
        addUser(txt);
        userInput.value = "";
        typing.style.display = "block";
        processInput(txt);
    }

    async function processInput(text) {
        if(text === "Ø­Ø°Ù") { localStorage.clear(); location.reload(); return; }

        if(step < 7) {
            handleReg(text);
            typing.style.display = "none";
            return;
        }

        if(step === 7) {
            userData.location = text;
            addBot(`Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "${text}" ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ... ğŸ“¡`);
            await fetchRealWeather(text);
            step = 8;
            typing.style.display = "none";
            return;
        }

        if(step === 8) {
            // Ø³Ø¤Ø§Ù„ Gemini
            try {
                const prompt = `
                    Ø£Ù†Øª Eco AIØŒ Ù…Ø³Ø§Ø¹Ø¯ ØµØ­ÙŠ ÙˆØ¨ÙŠØ¦ÙŠ.
                    Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userData.name}ØŒ Ø¹Ù…Ø±Ù‡ ${userData.age}.
                    Ø­Ø§Ù„ØªÙ‡ Ø§Ù„ØµØ­ÙŠØ©: ${userData.asthma ? "Ø±Ø¨Ùˆ" : "Ø³Ù„ÙŠÙ…"}ØŒ ${userData.heart ? "Ù‚Ù„Ø¨" : "Ø³Ù„ÙŠÙ…"}.
                    
                    Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ø¯ÙŠÙ‡ Ø§Ù„Ø¢Ù†:
                    Ø­Ø±Ø§Ø±Ø©: ${weatherData.current_weather.temperature}Â°C
                    Ø±ÙŠØ§Ø­: ${weatherData.current_weather.windspeed} km/h
                    
                    Ø§Ù„Ø³Ø¤Ø§Ù„: "${text}"
                    Ø£Ø¬Ø¨ Ø¨Ø§Ø®ØªØµØ§Ø± ÙˆÙ…Ø±Ø­. Ø§Ø±Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø¨Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„ØµØ­Ø© Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†.
                `;
                const result = await model.generateContent(prompt);
                addBot(format(result.response.text()));
            } catch(e) {
                addBot("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙØªØ§Ø­ Gemini.");
            }
            typing.style.display = "none";
        }
    }

    // --- Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­) ---
    async function fetchRealWeather(city) {
        try {
            // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Geocoding)
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=ar&format=json`);
            const geoData = await geoRes.json();

            if (!geoData.results) {
                addBot("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ Ù…Ø¯ÙŠÙ†Ø© Ø£ÙƒØ¨Ø±ØŸ");
                step = 7; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                return;
            }

            userData.lat = geoData.results[0].latitude;
            userData.lon = geoData.results[0].longitude;
            const cityName = geoData.results[0].name;

            // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userData.lat}&longitude=${userData.lon}&current_weather=true&hourly=pm10,pm2_5`);
            weatherData = await weatherRes.json();
            
            // ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªÙ„ÙˆØ« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ø£Ù† OpenMeteo Air Quality API Ù…Ù†ÙØµÙ„)
            const temp = weatherData.current_weather.temperature;
            const wind = weatherData.current_weather.windspeed;
            
            // Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù‚Ø³
            let html = `
                <div class="weather-card">
                    <div style="text-align:center; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:10px;">ğŸ“ ${cityName}</div>
                    <div class="weather-detail"><span>ğŸŒ¡ï¸ Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</span> <span>${temp}Â°C</span></div>
                    <div class="weather-detail"><span>ğŸ’¨ Ø§Ù„Ø±ÙŠØ§Ø­:</span> <span>${wind} km/h</span></div>
                    <div class="weather-detail"><span>ğŸŒ¤ï¸ Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙŠØ© âœ…</span></div>
                </div>
            `;
            addBot(html);

            // 3. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø·Ù‚Ø³
            const prompt = `
                Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…Ø¯ÙŠÙ†Ø©: ${cityName}.
                Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© ${temp} Ù…Ø¦ÙˆÙŠØ©ØŒ Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­ ${wind} ÙƒÙ…/Ø³.
                Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡: ${userData.asthma ? "Ø±Ø¨Ùˆ" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¨Ùˆ"}ØŒ ${userData.heart ? "Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨"}.
                
                Ø§ÙƒØªØ¨ Ù†ØµÙŠØ­Ø© Ø·Ø¨ÙŠØ© ÙˆØ¨ÙŠØ¦ÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©.
            `;
            const advice = await model.generateContent(prompt);
            addBot(`<div style="background:rgba(0,255,157,0.1); padding:10px; border-radius:5px; margin-top:5px;">${format(advice.response.text())}</div>`);
            
            setTimeout(() => addBot("Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„Ø¢Ù†!"), 1000);

        } catch (e) {
            console.error(e);
            addBot("ÙƒÙŠÙ ØªØ­Ø¨ Ø§Ù† Ø§Ø³Ø§Ø¹Ø¯Ùƒ");
            step = 7;
        }
    }

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function handleReg(text) {
        // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
        if(step===0) { userData.name=text; addBot("Ø£Ù‡Ù„Ø§Ù‹! ÙƒÙ… Ø¹Ù…Ø±ÙƒØŸ"); step++; }
        else if(step===1) { userData.age=text; addBot("ÙƒÙ… Ø·ÙˆÙ„ÙƒØŸ"); step++; }
        else if(step===2) { userData.height=text; addBot("ÙƒÙ… ÙˆØ²Ù†ÙƒØŸ"); step++; }
        else if(step===3) { userData.weight=text; addBot("Ù‡Ù„ Ø¹Ù†Ø¯Ùƒ Ø±Ø¨ÙˆØŸ"); step++; }
        else if(step===4) { userData.asthma=(text.includes("Ù†Ø¹Ù…")); addBot("Ù‡Ù„ Ø¹Ù†Ø¯Ùƒ Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ØŸ"); step++; }
        else if(step===5) { userData.heart=(text.includes("Ù†Ø¹Ù…")); addBot("Ø­Ø³Ø§Ø³ÙŠØ© Ø¬Ù„Ø¯ÙŠØ©ØŸ"); step++; }
        else if(step===6) { userData.skin=(text.includes("Ù†Ø¹Ù…")); localStorage.setItem('ecoAI_user', JSON.stringify(userData)); addBot("ØªÙ… Ø§Ù„Ø­ÙØ¸. Ø£ÙŠÙ† Ù…ÙƒØ§Ù†ÙƒØŸ"); step++; }
    }

    function addBot(h) { chatBox.innerHTML+=`<div class="message bot-message">${h}</div>`; chatBox.scrollTop=chatBox.scrollHeight; }
    function addUser(t) { chatBox.innerHTML+=`<div class="message user-message">${t}</div>`; chatBox.scrollTop=chatBox.scrollHeight; }
    function format(t) { return t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>'); }
</script>
</body>

</html>
